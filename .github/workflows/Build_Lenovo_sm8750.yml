name: Build_Lenovo_sm8750

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: "Select KSU Type"
        required: true
        type: choice
        options:
          - 'ReSukiSU'
          - 'SukiSU'
        default: 'ReSukiSU'
      kernel_version:
        description: "Select Kernel Version"
        required: true
        type: choice
        options:
          - '6.6.56'
          - '6.6.89'
          - '6.6.102'
        default: '6.6.89'
      custom_suffix:
        description: "Custom Kernel Suffix"
        required: false
        default: ''
      enable_kpm:
        description: "Enable KPM (Fix Detection)"
        required: true
        default: true
        type: boolean

jobs:
  build_kernel:
    name: Build_${{ github.event.inputs.kernel_version }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      KERNEL_REPO: "https://github.com/ParticleG/android_kernel_lenovo_sm8750.git"
      RESUKISU_REPO: "https://github.com/ReSukiSU/ReSukiSU.git"
      SUKISU_REPO: "https://github.com/SukiSU/SukiSU-Ultra.git"
      ANYKERNEL_REPO: "https://github.com/osm0sis/AnyKernel3.git"
      CCACHE_DIR: "${{ github.workspace }}/.ccache"
      CCACHE_MAXSIZE: "40G"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore CCACHE Cache
        id: ccache-restore
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-sm8750-${{ github.event.inputs.kernel_version }}-${{ github.sha }}
          restore-keys: |
            ccache-sm8750-${{ github.event.inputs.kernel_version }}-

      - name: Initialize CCACHE
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache -M ${{ env.CCACHE_MAXSIZE }}
          ccache -o compression=true
          ccache -s

      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y git-core clang llvm lld gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi bc bison flex libssl-dev libelf-dev python3-pip
          pip3 install pycryptodome
          git config --global http.sslVerify false

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 ${{ env.KERNEL_REPO }} kernel
          cd kernel || exit 1
          echo "Kernel version: $(make kernelversion)"

      - name: Apply KSU & KPM Patches
        run: |
          cd kernel || exit 1
          KSU_TYPE="${{ github.event.inputs.ksu_type }}"
          ENABLE_KPM="${{ github.event.inputs.enable_kpm }}"
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"

          if [ "$KSU_TYPE" = "ReSukiSU" ]; then
            git clone --depth=1 "$RESUKISU_REPO" resukisu
            PATCH_DIR="./resukisu/patches/$KERNEL_VER"
            patch -p1 < "$PATCH_DIR/resukisu.patch"
          else
            git clone --depth=1 "$SUKISU_REPO" sukisu
            PATCH_DIR="./sukisu/patches/$KERNEL_VER"
            patch -p1 < "$PATCH_DIR/sukisu.patch"
          fi

          if [ "$ENABLE_KPM" = "true" ]; then
            if [ -f "$PATCH_DIR/kpm.patch" ]; then
              patch -p1 < "$PATCH_DIR/kpm.patch"
              echo "✅ KPM patch applied"
            else
              echo "❌ KPM patch not found for $KERNEL_VER"
              exit 1
            fi

            export ARCH=arm64
            make lenovo_sm8750_defconfig
            scripts/config --enable CONFIG_KPM
            scripts/config --set-str KPM_VERSION "1.0.0"
            echo "#define KPM_VERSION \"1.0.0\"" > include/linux/kpm_version.h
            make savedefconfig
          fi

      - name: Compile Kernel
        run: |
          cd kernel || exit 1
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          export LLVM_IAS=1
          export CCACHE_PREFIX=ccache
          make -j$(nproc) Image.gz dtbo.img
          ls -lh arch/arm64/boot/Image.gz arch/arm64/boot/dtbo.img

      - name: Package Kernel (Fix YAML Indent Error)
        run: |
          # 1. 准备打包目录（缩进统一2空格）
          mkdir -p AnyKernel3
          cp kernel/arch/arm64/boot/Image.gz AnyKernel3/
          cp kernel/arch/arm64/boot/dtbo.img AnyKernel3/
          git clone --depth=1 "$ANYKERNEL_REPO" AnyKernel3-Template
          cp -r AnyKernel3-Template/* AnyKernel3/
          rm -rf AnyKernel3-Template

          # 2. 生成刷入脚本（核心修复：EOF无引号 + 内部语句缩进与cat对齐）
          cat > AnyKernel3/META-INF/com/google/android/updater-script << EOF
ui_print("Flashing Lenovo sm8750 Kernel");
ui_print("Version: ${{ github.event.inputs.kernel_version }}");
ui_print("KSU: ${{ github.event.inputs.ksu_type }}");
ui_print("KPM: ${{ github.event.inputs.enable_kpm }}");
package_extract_file("Image.gz", "/dev/block/bootdevice/by-name/boot");
package_extract_file("dtbo.img", "/dev/block/bootdevice/by-name/dtbo");
ui_print("Flash completed!");
EOF

          # 3. 打包内核（变量引用标准化）
          SUFFIX="${{ github.event.inputs.custom_suffix }}"
          if [ -z "$SUFFIX" ]; then
            SUFFIX="KPM_Enabled"
          fi
          ZIP_NAME="Lenovo_sm8750_${{ github.event.inputs.kernel_version }}_${{ github.event.inputs.ksu_type }}_${SUFFIX}.zip"
          cd AnyKernel3 && zip -r9 "../$ZIP_NAME" . -x "*.git*" "*.md" "LICENSE"
          cd .. && ls -lh "$ZIP_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Lenovo_sm8750_Kernel
          path: Lenovo_sm8750_*.zip
          retention-days: 7

      - name: Save CCACHE Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ steps.ccache-restore.outputs.cache-primary-key }}
