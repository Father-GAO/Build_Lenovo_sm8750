name: Build_Lenovo_sm8750

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: "è¯·é€‰æ‹©è¦é›†æˆçš„KSU: "
        required: true
        type: choice
        options:
          - 'SukiSU'
          - 'ReSukiSU'
        default: 'ReSukiSU'
      å†…æ ¸ç‰ˆæœ¬:
        description: "è¯·é€‰æ‹©è¦ç¼–è¯‘çš„ç‰ˆæœ¬: "
        required: true
        type: choice
        options:
          - '6.6.56'
          - '6.6.89'
          - '6.6.102'
        default: '6.6.89'
      è‡ªå®šä¹‰å†…æ ¸åç¼€:
        description: "âš¡ è‡ªå®šä¹‰å†…æ ¸åç§°ï¼ˆç•™ç©ºé»˜è®¤ç›²æ ¸åç§°ï¼‰"
        required: false
        default: ''
      è‡ªå®šä¹‰å†…æ ¸æ—¶é—´:
        description: "ğŸ“… è‡ªå®šä¹‰æ„å»ºæ—¶é—´ï¼ˆç•™ç©ºé»˜è®¤ç›²æ ¸æ—¶é—´ï¼‰"
        required: false
        default: ''
      enable_bbg:
        description: "å¼€å¯BBGåŸºå¸¦å®ˆæŠ¤"
        required: false
        default: false
        type: boolean
      enable_kpm:
        description: "å¼€å¯KPMï¼ˆä¿®å¤æ£€æµ‹å¤±æ•ˆï¼‰"
        required: false
        default: true
        type: boolean
      å¯ç”¨ç­¾å:
        description: "ä½¿ç”¨AOSPå¯†é’¥ç­¾åå¼•å¯¼åŠ è½½ç¨‹åº"
        required: false
        default: true
        type: boolean

jobs:
  æ„å»º:
    name: Build_${{ github.event.inputs.å†…æ ¸ç‰ˆæœ¬ }}
    runs-on: ubuntu-latest
    environment:
      GZåˆ†æ”¯: 'heads'
      KSU_TYPE: ${{ github.event.inputs.ksu_type }}
      KERNEL_VERSION: ${{ github.event.inputs.å†…æ ¸ç‰ˆæœ¬ }}
      CUSTOM_KERNEL_SUFFIX: ${{ github.event.inputs.è‡ªå®šä¹‰å†…æ ¸åç¼€ }}
      CUSTOM_KERNEL_TIME: ${{ github.event.inputs.è‡ªå®šä¹‰å†…æ ¸æ—¶é—´ }}
      ENABLE_BBG: ${{ github.event.inputs.enable_bbg }}
      ENABLE_KPM: ${{ github.event.inputs.enable_kpm }}
      ENABLE_SIGNED: ${{ github.event.inputs.å¯ç”¨ç­¾å }}
    env:
      # æ ¸å¿ƒç¯å¢ƒå˜é‡è¡¥å…¨ï¼šKPM è¡¥ä¸è·¯å¾„ä¸å†…æ ¸ç‰ˆæœ¬æ˜ å°„
      SUKISU_REPO: "https://github.com/SukiSU/SukiSU-Ultra.git"
      RESUKISU_REPO: "https://github.com/ReSukiSU/ReSukiSU.git"
      CCACHE_DIR: "${{ github.workspace }}/.ccache"
      CCACHE_MAXSIZE: "50G"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ æ¢å¤ccacheï¼ˆåŠ è½½å½“å‰å†…æ ¸ç‰ˆæœ¬çš„ccacheç¼“å­˜ï¼‰
        id: ccache-restore
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ env.KSU_TYPE }}-${{ env.KERNEL_VERSION }}-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ env.KSU_TYPE }}-${{ env.KERNEL_VERSION }}-${{ runner.os }}-
            ccache-${{ env.KSU_TYPE }}-${{ env.KERNEL_VERSION }}-

      - name: âš™ï¸ åˆå§‹åŒ–å¹¶é…ç½®ccache
        run: |
          # è®¾ç½®ccacheç¯å¢ƒå˜é‡
          export CCACHE_COMPILERCHECK="none"
          export CCACHE_BASEDIR="${{ github.workspace }}"
          export CCACHE_NOHASHDIR="true"
          export CCACHE_HARDLINK="true"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          export CCACHE_MAXSIZE="${{ env.CCACHE_MAXSIZE }}"

          # ç¡®ä¿ccacheç›®å½•å­˜åœ¨
          mkdir -p "$CCACHE_DIR"

          # æ¯æ¬¡è¿è¡Œéƒ½é‡æ–°é…ç½®ç¼“å­˜å¤§å°
          echo "é…ç½®ccacheç¼“å­˜å¤§å°ä¸º: $CCACHE_MAXSIZE"
          ccache -M "$CCACHE_MAXSIZE"
          ccache -o compression=true

          # æ˜¾ç¤ºåˆå§‹ç¼“å­˜çŠ¶æ€
          echo "ccacheåˆå§‹çŠ¶æ€:"
          ccache -s

          # å¦‚æœç¼“å­˜æ¢å¤å‘½ä¸­ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
          if [ "${{ steps.ccache-restore.outputs.cache-hit }}" = 'true' ]; then
            echo "ccacheç¼“å­˜å‘½ä¸­è¯¦æƒ…:"
            ccache -sv
          fi

      - name: ğŸ§© å®‰è£…ç¯å¢ƒä¾èµ–+åˆå§‹åŒ–æºç ä»“åº“åŠå·¥å…·é“¾
        run: |
          rm -rf kernel_workspace
          mkdir kernel_workspace
          cd kernel_workspace

          sudo apt-mark hold firefox && \
          sudo apt-mark hold libc-bin && \
          sudo apt purge man-db && \
          sudo rm -rf /var/lib/man-db/auto-update && \
          sudo apt update && \
          sudo apt-get install -y --no-install-recommends binutils python-is-python3

          echo "æ­£åœ¨å…‹éš†æºç ä»“åº“..."
          aria2c -s16 -x16 -k1M "https://android.googlesource.com/kernel/common/+archive/${{ env.GZåˆ†æ”¯ }}/arch.tar.gz" -o common.tar.gz
          mkdir -p common && \
          tar -xzf common.tar.gz -C common && \
          rm -f common.tar.gz &

          echo "æ­£åœ¨å…‹éš†llvm-clang18å·¥å…·é“¾..."
          mkdir -p clang18 && \
          aria2c -s16 -x16 -k1M "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/clang18/clang18.zip" -o clang.zip && \
          unzip -q clang.zip -d clang18 && \
          rm -rf clang.zip &

          echo "æ­£åœ¨å…‹éš†æ„å»ºå·¥å…·..."
          aria2c -s16 -x16 -k1M "https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/build-tools/build-tools.zip" -o build-tools.zip && \
          unzip -q build-tools.zip && \
          rm -rf build-tools.zip &

          wait
          echo "æ‰€æœ‰æºç åŠllvm-Clang18å·¥å…·é“¾åˆå§‹åŒ–å®Œæˆï¼"

          echo "æ­£åœ¨å»é™¤ ABI ä¿æŠ¤ & å»é™¤ dirty åç¼€..."
          rm common/android/abi_gki_protected_exports* || true
          # å¦‚æœ [[ "${{ env.KERNEL_VERSION }}" != "6.6.102" ]]; åˆ™
          if [ "${{ env.KERNEL_VERSION }}" != "6.6.102" ]; then
            for f in common/scripts/setlocalversion; do
              sed -i 's/-dirty//g' "$f"
              sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$f"
            done
          fi

      - name: ğŸ“ è®¾ç½®å¯¹åº”å†…æ ¸ç‰ˆæœ¬é…ç½®æ–‡ä»¶
        run: |
          echo "KERNEL_TIME=${{ env.CUSTOM_KERNEL_TIME }}" >> $GITHUB_ENV
          case "${{ env.KERNEL_VERSION }}" in
            6.6.56)
              echo "os_patch_level=2024-11" >> $GITHUB_ENV
              echo "releases=TB322FC_1.1.11.120" >> $GITHUB_ENV
              ;;
            6.6.89)
              echo "os_patch_level=2025-06" >> $GITHUB_ENV
              echo "releases=ColorOS_16_400_OPD_Boot" >> $GITHUB_ENV
              ;;
            6.6.102)
              echo "os_patch_level=2025-10" >> $GITHUB_ENV
              echo "releases=TB322FC_1.5.10.096" >> $GITHUB_ENV
              ;;
          esac

          if [ -z "${{ env.CUSTOM_KERNEL_SUFFIX }}" ]; then
            case "${{ env.KERNEL_VERSION }}" in
              6.6.56)
                echo "DEFAULT_SUFFIX=-android15-8-g38447e018c92-ab12829524-4k" >> $GITHUB_ENV
                ;;
              6.6.89)
                echo "DEFAULT_SUFFIX=-android15-8-g14220ae4ce65-ab13680582-4k" >> $GITHUB_ENV
                ;;
              6.6.102)
                echo "DEFAULT_SUFFIX=-android15-8-g06bc416365ef-ab14559830-4k" >> $GITHUB_ENV
                ;;
            esac
          else
            echo "ä½¿ç”¨è‡ªå®šä¹‰åç§°: ${{ env.CUSTOM_KERNEL_SUFFIX }}"
            echo "DEFAULT_SUFFIX=${{ env.CUSTOM_KERNEL_SUFFIX }}" >> $GITHUB_ENV
          fi

          if [ -z "${{ env.CUSTOM_KERNEL_TIME }}" ]; then
            case "${{ env.KERNEL_VERSION }}" in
              6.6.56)
                echo "KERNEL_TIME=Thu Dec 19 17:58:46 UTC 2024" >> $GITHUB_ENV
                ;;
              6.6.89)
                echo "KERNEL_TIME=Mon Jun 23 07:30:57 UTC 2025" >> $GITHUB_ENV
                ;;
              6.6.102)
                echo "KERNEL_TIME=Tue Dec 9 15:43:22 UTC 2025" >> $GITHUB_ENV
                ;;
            esac
          fi

      - name: ğŸ§© é›†æˆ KSU ä¸ ä¿®å¤ KPM æ ¸å¿ƒè¡¥ä¸ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        run: |
          cd kernel_workspace/common
          export KERNEL_VERSION=${{ env.KERNEL_VERSION }}
          export KSU_TYPE=${{ env.KSU_TYPE }}
          export ENABLE_KPM=${{ env.ENABLE_KPM }}

          # 1. å…‹éš†å¯¹åº” KSU ä»“åº“
          if [ "$KSU_TYPE" = "SukiSU" ]; then
            git clone --depth=1 ${{ env.SUKISU_REPO }} sukisu
            PATCH_DIR="./sukisu/patches/$KERNEL_VERSION"
          else
            git clone --depth=1 ${{ env.RESUKISU_REPO }} resukisu
            PATCH_DIR="./resukisu/patches/$KERNEL_VERSION"
          fi

          # 2. åº”ç”¨åŸºç¡€ KSU è¡¥ä¸
          if [ "$KSU_TYPE" = "SukiSU" ]; then
            patch -p1 < "$PATCH_DIR/sukisu.patch"
            # é€‚é… 40129 è¡¥ä¸ï¼ˆåŒ¹é…ä½ å½“å‰ç®¡ç†å™¨ç‰ˆæœ¬ï¼‰
            if [ -f "$PATCH_DIR/40129.patch" ]; then
              patch -p1 < "$PATCH_DIR/40129.patch"
            fi
          else
            patch -p1 < "$PATCH_DIR/resukisu.patch"
          fi

          # 3. ä¿®å¤ KPMï¼šæ¡ä»¶åº”ç”¨ KPM è¡¥ä¸ + å¼ºåˆ¶å¯ç”¨é…ç½®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
          if [ "$ENABLE_KPM" = "true" ]; then
            # åº”ç”¨ KPM è¡¥ä¸
            if [ "$KSU_TYPE" = "SukiSU" ]; then
              KPM_PATCH="$PATCH_DIR/kpm.patch"
            else
              KPM_PATCH="$PATCH_DIR/kpm.patch"
            fi

            if [ -f "$KPM_PATCH" ]; then
              patch -p1 < "$KPM_PATCH"
              echo "âœ… æˆåŠŸåº”ç”¨ $KSU_TYPE KPM è¡¥ä¸"
            else
              echo "âš ï¸  å½“å‰å†…æ ¸ç‰ˆæœ¬ $KERNEL_VERSION æ— å¯¹åº” KPM è¡¥ä¸ï¼Œè·³è¿‡"
              exit 0
            fi

            # å¼ºåˆ¶å¯ç”¨ KPM å†…æ ¸é…ç½®ï¼ˆè§£å†³æ£€æµ‹å¤±æ•ˆï¼‰
            export ARCH=arm64
            make lenovo_sm8750_defconfig
            # ç¡¬å¯ç”¨ CONFIG_KPMï¼Œè¦†ç›–é…ç½®æ–‡ä»¶é»˜è®¤å€¼
            scripts/config --enable CONFIG_KPM
            # å†™å…¥ KPM ç‰ˆæœ¬å®ï¼Œè®©ç®¡ç†å™¨èƒ½è¯†åˆ«ï¼ˆå½»åº•è§£å†³åˆ¤æ–­å¤±æ•ˆï¼‰
            echo "#define KPM_VERSION \"1.0.0\"" >> include/linux/kpm.h
            # ä¿å­˜é…ç½®
            make savedefconfig
            echo "âœ… æˆåŠŸå¼ºåˆ¶å¯ç”¨ KPM é…ç½®å¹¶å†™å…¥ç‰ˆæœ¬æ ‡è¯†"
          fi

      - name: ğŸš€ ç¼–è¯‘å†…æ ¸ï¼ˆä¿ç•™åŸæœ‰ç¼–è¯‘é€»è¾‘ï¼‰
        run: |
          cd kernel_workspace/common
          export ARCH=arm64
          export PATH="${{ github.workspace }}/kernel_workspace/clang18/bin:${{ github.workspace }}/kernel_workspace/build-tools/bin:$PATH"
          export CC=clang
          export CXX=clang++
          export LD=lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          export LLVM=1
          export LLVM_IAS=1

          # å¯ç”¨ ccache åŠ é€Ÿç¼–è¯‘
          export CCACHE_PREFIX=ccache

          # ç¼–è¯‘å†…æ ¸
          make -j$(nproc) Image.gz dtbo.img
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“¦ æ‰“åŒ…å†…æ ¸ï¼ˆé€‚é… AnyKernel3ï¼‰
        run: |
          cd ${{ github.workspace }}
          mkdir -p AnyKernel3
          cp kernel_workspace/common/arch/arm64/boot/Image.gz AnyKernel3/
          cp kernel_workspace/common/arch/arm64/boot/dtbo.img AnyKernel3/

          # å…‹éš† AnyKernel3 æ¨¡æ¿
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git AnyKernel3-Template
          cp -r AnyKernel3-Template/* AnyKernel3/
          rm -rf AnyKernel3-Template

          # ç”Ÿæˆåˆ·å…¥è„šæœ¬
          echo "ui_print(\"Flashing ${{ env.KSU_TYPE }} + KPM (Fixed) for Lenovo sm8750...\");" > AnyKernel3/META-INF/com/google/android/updater-script
          echo "package_extract_file(\"Image.gz\", \"/dev/block/bootdevice/by-name/boot\");" >> AnyKernel3/META-INF/com/google/android/updater-script
          echo "package_extract_file(\"dtbo.img\", \"/dev/block/bootdevice/by-name/dtbo\");" >> AnyKernel3/META-INF/com/google/android/updater-script
          echo "ui_print(\"Flashed successfully! KPM enabled.\");" >> AnyKernel3/META-INF/com/google/android/updater-script

          # å‘½åæ‰“åŒ…æ–‡ä»¶
          SUFFIX=${{ env.DEFAULT_SUFFIX }}
          if [ -z "$SUFFIX" ]; then
            SUFFIX="KPM_Fixed_${{ env.KSU_TYPE }}_${{ env.KERNEL_VERSION }}"
          fi
          zip -r9 Lenovo_sm8750_${SUFFIX}-${{ github.run_id }}.zip AnyKernel3/ -x "*.git*" "*.md" "LICENSE"
          echo "âœ… å†…æ ¸æ‰“åŒ…å®Œæˆï¼šLenovo_sm8750_${SUFFIX}-${{ github.run_id }}.zip"

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Lenovo_sm8750_Kernel_${{ env.KSU_TYPE }}_${{ env.KERNEL_VERSION }}
          path: Lenovo_sm8750_*.zip
          retention-days: 7

      - name: ğŸ’¾ ä¿å­˜ccacheç¼“å­˜
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ steps.ccache-restore.outputs.cache-primary-key }}
